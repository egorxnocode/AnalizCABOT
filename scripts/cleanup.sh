#!/bin/bash

# –°–∫—Ä–∏–ø—Ç –æ—á–∏—Å—Ç–∫–∏ –ø—É–ª–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π Telegram –±–æ—Ç–∞
set -e

# –û–ø—Ä–µ–¥–µ–ª—è–µ–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é —Å–∫—Ä–∏–ø—Ç–∞
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_DIR="$(dirname "$SCRIPT_DIR")"

# –ü–µ—Ä–µ—Ö–æ–¥–∏–º –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –ø—Ä–æ–µ–∫—Ç–∞
cd "$PROJECT_DIR"

# –¶–≤–µ—Ç–∞ –¥–ª—è –≤—ã–≤–æ–¥–∞
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –∏–∑ .env
if [ -f ".env" ]; then
    export $(grep -v '^#' .env | xargs)
fi

BOT_NAME=${BOT_NAME:-default}
CONTAINER_NAME="telegram-bot-$BOT_NAME"

echo -e "${BLUE}üßπ –û—á–∏—Å—Ç–∫–∞ –ø—É–ª–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π –±–æ—Ç–∞ '$BOT_NAME'${NC}"
echo -e "${BLUE}============================================${NC}"

# –§—É–Ω–∫—Ü–∏—è –º—è–≥–∫–æ–π –æ—á–∏—Å—Ç–∫–∏ (–ø–µ—Ä–µ–∑–∞–ø—É—Å–∫ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞)
soft_cleanup() {
    echo -e "${YELLOW}üîÑ –ú—è–≥–∫–∞—è –æ—á–∏—Å—Ç–∫–∞ (–ø–µ—Ä–µ–∑–∞–ø—É—Å–∫ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞)...${NC}"
    
    if docker-compose restart telegram-bot; then
        echo -e "${GREEN}‚úÖ –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω${NC}"
        sleep 5
        ./scripts/status.sh
        return 0
    else
        echo -e "${RED}‚ùå –û—à–∏–±–∫–∞ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞${NC}"
        return 1
    fi
}

# –§—É–Ω–∫—Ü–∏—è –∂–µ—Å—Ç–∫–æ–π –æ—á–∏—Å—Ç–∫–∏ (–ø–æ–ª–Ω–∞—è –ø–µ—Ä–µ—Å–±–æ—Ä–∫–∞)
hard_cleanup() {
    echo -e "${YELLOW}üî® –ñ–µ—Å—Ç–∫–∞—è –æ—á–∏—Å—Ç–∫–∞ (–ø–æ–ª–Ω–∞—è –ø–µ—Ä–µ—Å–±–æ—Ä–∫–∞)...${NC}"
    
    echo -e "${YELLOW}–û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é –±–æ—Ç–∞...${NC}"
    ./scripts/stop.sh
    
    echo -e "${YELLOW}–û—á–∏—â–∞—é Docker –∫—ç—à...${NC}"
    docker system prune -f
    
    echo -e "${YELLOW}–ü–µ—Ä–µ—Å–æ–±–∏—Ä–∞—é –æ–±—Ä–∞–∑...${NC}"
    docker-compose build --no-cache
    
    echo -e "${YELLOW}–ó–∞–ø—É—Å–∫–∞—é –±–æ—Ç–∞...${NC}"
    ./scripts/start.sh
    
    echo -e "${GREEN}‚úÖ –ñ–µ—Å—Ç–∫–∞—è –æ—á–∏—Å—Ç–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞${NC}"
    ./scripts/status.sh
}

# –§—É–Ω–∫—Ü–∏—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–æ–±–ª–µ–º —Å –ø—É–ª–æ–º
check_pool_issues() {
    echo -e "${YELLOW}üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–æ–±–ª–µ–º —Å –ø—É–ª–æ–º...${NC}"
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ª–æ–≥–∏ –Ω–∞ –æ—à–∏–±–∫–∏ –ø—É–ª–∞
    if docker-compose logs --tail=50 telegram-bot 2>/dev/null | grep -q "Pool timeout"; then
        echo -e "${RED}‚ùå –û–±–Ω–∞—Ä—É–∂–µ–Ω—ã –æ—à–∏–±–∫–∏ –ø—É–ª–∞ –≤ –ª–æ–≥–∞—Ö${NC}"
        return 1
    else
        echo -e "${GREEN}‚úÖ –û—à–∏–±–æ–∫ –ø—É–ª–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ${NC}"
        return 0
    fi
}

# –û—Å–Ω–æ–≤–Ω–∞—è –ª–æ–≥–∏–∫–∞
main() {
    local mode=${1:-"auto"}
    
    case $mode in
        "check")
            check_pool_issues
            ;;
        "soft")
            soft_cleanup
            ;;
        "hard")
            hard_cleanup
            ;;
        "auto")
            echo -e "${BLUE}ü§ñ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—á–∏—Å—Ç–∫–∞...${NC}"
            
            if check_pool_issues; then
                echo -e "${GREEN}‚úÖ –ü—Ä–æ–±–ª–µ–º –Ω–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–æ${NC}"
            else
                echo -e "${YELLOW}‚ö†Ô∏è –û–±–Ω–∞—Ä—É–∂–µ–Ω—ã –ø—Ä–æ–±–ª–µ–º—ã, –≤—ã–ø–æ–ª–Ω—è—é –º—è–≥–∫—É—é –æ—á–∏—Å—Ç–∫—É...${NC}"
                if ! soft_cleanup; then
                    echo -e "${YELLOW}‚ö†Ô∏è –ú—è–≥–∫–∞—è –æ—á–∏—Å—Ç–∫–∞ –Ω–µ –ø–æ–º–æ–≥–ª–∞, –≤—ã–ø–æ–ª–Ω—è—é –∂–µ—Å—Ç–∫—É—é...${NC}"
                    hard_cleanup
                fi
            fi
            ;;
        *)
            echo "–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: $0 [check|soft|hard|auto]"
            echo "  check - –¢–æ–ª—å–∫–æ –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–æ–±–ª–µ–º —Å –ø—É–ª–æ–º"
            echo "  soft  - –ú—è–≥–∫–∞—è –æ—á–∏—Å—Ç–∫–∞ (–ø–µ—Ä–µ–∑–∞–ø—É—Å–∫ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞)"
            echo "  hard  - –ñ–µ—Å—Ç–∫–∞—è –æ—á–∏—Å—Ç–∫–∞ (–ø–æ–ª–Ω–∞—è –ø–µ—Ä–µ—Å–±–æ—Ä–∫–∞)"
            echo "  auto  - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –≤—ã–±–æ—Ä –º–µ—Ç–æ–¥–∞ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)"
            exit 1
            ;;
    esac
}

main "$@"